---
title: "R Notebook"
output: html_notebook
---

# Overview

Analyse and visualise trips on the Sydney Trains Network.

# Setup

```{r, message=FALSE}
rm(list=ls())

library(tidyverse)
library(forcats)
library(stringr)

src_folder <- "data/2017-03-09/"
theme_set(theme_minimal())
```

# Import

```{r}
read_routes <- function () { read_csv(file.path(src_folder, "routes.csv")) }
read_stops <- function () { read_csv(file.path(src_folder, "stops.csv")) }
read_shapes <- function () { read_csv(file.path(src_folder, "shapes.csv")) }
read_trips <- function () { read_csv(file.path(src_folder, "trips.csv")) }
read_stop_times <- function () { read_csv(file.path(src_folder, "stop_times.csv")) }
```

# Transform

```{r}
transform_routes <- function (df) {
  df %>%
    filter(route_desc == "Sydney Trains Network") %>%
    select(route_id, route_long_name) %>%
    mutate(route_id = as_factor(route_id))
}

transform_stops <- function (df) {
  df %>%
    select(-location_type) %>%
    mutate_at(c("stop_id"), as.factor)
}

transform_trips <- function (df) {
  df %>%
    mutate(direction_id = direction_id %>% as.character %>% as_factor) %>%
    mutate_at(vars(route_id : shape_id), as_factor)
}

transform_stop_times <- function (df) {
  df %>%
    mutate_at(vars(ends_with("_id")), as.factor) %>%
    select(-pickup_type, -drop_off_type, -stop_headsign)
}
```

# Analysis

Group trips into stops, ignoring times

```{r}
unique_trips <- function (df) {
  df %>%
    group_by(
      route_long_name, 
      trip_id) %>%
    select(
      route_long_name,
      trip_id,
      stop_sequence,
      stop_name) %>%
    arrange(
      trip_id, 
      stop_sequence)
}
```

All trip starts and ends

```{r}
trip_endpoints <- function (df) {
  starts <- 
    df %>%
    group_by(route_id, trip_id) %>%
    filter(stop_sequence == 1) %>%
    select(route_id, trip_id, start_stop = stop_name)
  
  df %>%
    group_by(route_id, trip_id) %>%
    filter(stop_sequence == max(stop_sequence)) %>%
    select(route_id, trip_id, end_stop = stop_name) %>%
    inner_join(starts)
}
```

Create a graph of all stops

```{r}
# Get all the stops --> graph nodes
all_stops <- function (df = stops) {
  df %>%
    select(stop_name, stop_id, stop_lat, stop_lon) %>%
    unique
}
```


# Run

Read the data and do repeated joins to create an aggregate data frame. For the 2017-03-09 data set, this is 482566 rows x 21 columns.

```{r, message=FALSE}
t_lines <- 
  read_routes() %>% 
  transform_routes

# Match only on route_id
trips <-
  read_trips() %>%
  transform_trips %>%
  inner_join(t_lines)

# Match only on trip_id
stop_times <-
  read_stop_times() %>%
  transform_stop_times %>%
  inner_join(trips) 

# Match only on stop_id
stops <- 
  read_stops() %>% 
  transform_stops %>%
  inner_join(stop_times)

# Final data
glimpse(stops)
```

# Visualise

Get all the unique trips across the network as endpoints, regardless of times
```{r}
trip_ends <- 
  stops %>% 
  trip_endpoints %>%
  ungroup(trip_id) %>%
  select(-trip_id) %>%
  unique() %>%
  arrange(route_id)
```

# Show a graph of the trips between endpoints

```{r}
library(igraph)

plot_endpoints <- function (df = trip_ends) {
  all_ends <- c(trip_ends$start_stop, trip_ends$end_stop) %>% unique
  gr <- 
    trip_ends %>%
    select(-route_id) %>%
    graph_from_data_frame(directed = TRUE, vertices = all_ends)

  deg <- gr %>% degree(mode = "all")
  layout <- 
    layout_with_lgl(gr) %>% 
    norm_coords(ymin=-1, ymax=1, xmin=-1, xmax=1)
  
  gr %>% 
    plot(vertex.size = log(deg) * 2,
         # vertex.label.cex = 0.3,
         vertex.color = "#6666ff",
         vertex.label = NA,
         edge.color = "#CC6666",
         edge.arrow.size = 0,
         rescale = FALSE,
         layout =  layout * 1.0)
}
  
```


```{r}
trip_ends %>% plot_endpoints
```

